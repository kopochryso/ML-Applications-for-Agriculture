import joblib
import numpy as np
import pandas as pd
from skl2onnx import convert_sklearn
from skl2onnx.common.data_types import FloatTensorType
import onnxruntime as rt

# 1. Load the trained model
MODEL_PATH = "root_yield_model.pkl"
model = joblib.load(MODEL_PATH)
print(f"Loaded model from {MODEL_PATH}")

# 2. Define feature order (same as predict_local)
FEATURE_ORDER = [
    "dps",
    "soil_moisture_30",
    "soil_moisture_60",
    "soil_moisture_90",
    "PAW_30",
    "PAW_60",
    "PAW_90",
    "LAI",
    "min_temp",
    "max_temp",
    "av_temp",
    "precipitation",
    "glob_radiation",
    "ET_grass",
    "irrigation_binary",
]

n_features = len(FEATURE_ORDER)

# 3. Convert scikit-learn model to ONNX
initial_type = [("float_input", FloatTensorType([None, n_features]))]
onnx_model = convert_sklearn(model, initial_types=initial_type)

ONNX_PATH = "root_yield_model.onnx"
with open(ONNX_PATH, "wb") as f:
    f.write(onnx_model.SerializeToString())

print(f"Saved ONNX model to {ONNX_PATH}")

# 4. Test ONNX inference with a dummy example
sess = rt.InferenceSession(ONNX_PATH, providers=["CPUExecutionProvider"])

input_name = sess.get_inputs()[0].name
output_name = sess.get_outputs()[0].name

# create one test sample (same order as FEATURE_ORDER)
sample = np.array([[
    120,   # dps
    32.0,  # soil_moisture_30
    28.0,  # soil_moisture_60
    25.0,  # soil_moisture_90
    50.0,  # PAW_30
    45.0,  # PAW_60
    40.0,  # PAW_90
    4.2,   # LAI
    12.0,  # min_temp
    25.0,  # max_temp
    18.0,  # av_tempcd bee  
    3.0,   # precipitation
    19.0,  # glob_radiation
    3.0,   # ET_grass
    1.0,   # irrigation_binary (yes)
]], dtype=np.float32)

pred_onnx = sess.run([output_name], {input_name: sample})[0]
print("ONNX model prediction for sample:", float(pred_onnx[0]))
